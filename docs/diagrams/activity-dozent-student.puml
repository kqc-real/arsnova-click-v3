@startuml activity-dozent-student
' ============================================================================
' arsnova.click V3 â€“ Activity-Diagramm: Dozent / Student / Server
' VollstÃ¤ndiger Quiz-Lifecycle inkl. Bonus-Token, Preview, SC-Formate
' Stand: 2026-02-19 Â· 56 Storys Â· 9 Epics
'
' Farblegende (Activity-Boxen einzeln eingefÃ¤rbt):
'   ğŸŸ© #c8e6c9 = Dozent
'   ğŸŸ¦ #bbdefb = Student
'   ğŸŸ§ #ffe0b2 = Server
' ============================================================================

skinparam shadowing false
skinparam ActivityBorderColor #444444
skinparam ActivityFontColor #222222
skinparam ArrowColor #555555
skinparam ActivityDiamondBorderColor #444444
skinparam SwimlaneBorderColor #888888
skinparam SwimlaneBorderThickness 2
skinparam SwimlaneTitleFontSize 16
skinparam SwimlaneTitleFontStyle bold

title arsnova.click V3 â€” AktivitÃ¤tsdiagramm\nDozent Â· Student Â· Server\nğŸŸ© Dozent  ğŸŸ¦ Student  ğŸŸ§ Server

|Dozent|
|Student|
|Server|

' â”€â”€â”€ Phase 1: Quiz erstellen (Local-First) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Dozent|
start
#c8e6c9:Quiz erstellen\n(Name, Beschreibung);

if (Preset wÃ¤hlen?) then (ja)
  #c8e6c9:ğŸ® Spielerisch **oder** ğŸ“ SeriÃ¶s\nauswÃ¤hlen (Story 1.11);
  #c8e6c9:Toggles automatisch setzen\n(nach Wunsch anpassbar);
else (nein)
  #c8e6c9:Einzelne Toggles manuell setzen\n(Leaderboard, Sound, Emoji, â€¦);
endif

#c8e6c9:bonusTokenCount konfigurieren?\n(Story 4.6: Top X erhalten Token);

#c8e6c9:Fragen hinzufÃ¼gen;

repeat
  if (Fragentyp?) then (SC)
    if (SC-Schnellformat?) then (ja)
      #c8e6c9:Schnellformat wÃ¤hlen\n(Story 1.12: Ja/Nein,\nWahr/Falsch, A/B/C/D);
    else (nein)
      #c8e6c9:Antworten manuell eingeben;
    endif
    #c8e6c9:Korrekte Antwort(en) markieren;
  elseif (MC) then
    #c8e6c9:Antworten eingeben\n(mehrere korrekt);
    #c8e6c9:Korrekte markieren;
  elseif (Freitext) then
    #c8e6c9:Nur Fragenstamm eingeben\n(keine Optionen);
  elseif (Rating) then
    #c8e6c9:Skala konfigurieren\n(Min/Max, Labels);
  elseif (Survey) then
    #c8e6c9:Optionen ohne isCorrect;
  endif

  #c8e6c9:Schwierigkeitsgrad wÃ¤hlen\n(Easy/Medium/Hard);
  #c8e6c9:Markdown & KaTeX im Editor\n(Story 1.7: Live-Preview);
  #c8e6c9:In Yjs/IndexedDB speichern\n(Local-First, kein Server);

repeat while (Weitere Frage?) is (ja)

' â”€â”€â”€ Phase 2: Quiz-Preview (Story 1.13) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

#c8e6c9:Quiz-Preview Ã¶ffnen ğŸ‘ï¸\n(Story 1.13);
#c8e6c9:Fragen durchblÃ¤ttern\n(Hotkeys: â†’/â† N/P Home/End 1-9);
if (Validierungsprobleme?) then (ja)
  #c8e6c9:âš ï¸ Warnung anklicken\nâ†’ zur Frage springen;
  #c8e6c9:Inline-Schnellkorrektur\n(Text klicken / isCorrect togglen\n/ Hotkey E);
  #c8e6c9:Ã„nderung â†’ sofort Yjs-Sync;
else (nein)
  #c8e6c9:âœ… Alle Fragen valide\nâ€” bereit zum Live-Schalten;
endif

' â”€â”€â”€ Phase 3: Quiz live schalten â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

#c8e6c9:â€Live schalten" klicken;

|Server|
#ffe0b2:Quiz-Daten empfangen\n(QuizUploadInputSchema validieren);
#ffe0b2:Quiz + Questions + AnswerOptions\nin PostgreSQL speichern;
#ffe0b2:Session erstellen\n(6-stelliger Code generieren\nStatus = LOBBY);

if (Session-Typ?) then (QUIZ)
  #ffe0b2:quizId setzen;
else (Q_AND_A)
  #ffe0b2:title setzen\nquizId = null;
endif

#ffe0b2:â†’ { sessionId, code: "A3F7K2" };

|Dozent|
#c8e6c9:Session-Code + QR-Code anzeigen\n(Beamer-Ansicht Ã¶ffnen);
#c8e6c9:WebSocket-Subscriptions starten\n(onParticipantJoined,\nonStatusChanged);

' â”€â”€â”€ Phase 4: Studenten treten bei â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Student|
#bbdefb:Session-Code eingeben\n(6-stellig, Story 3.1);

|Server|
#ffe0b2:Code validieren\n(Session existiert? Status=LOBBY?);

if (Rate-Limit OK?) then (ja)
  #ffe0b2:âœ… Session-Info zurÃ¼ckgeben;
else (nein)
  #ffe0b2:âŒ TOO_MANY_REQUESTS\n(5 Versuche / 5 Min);
  stop
endif

|Student|
if (anonymousMode?) then (ja)
  #bbdefb:Automatisches Pseudonym\nâ€Teilnehmer #7";
else (nein)
  #bbdefb:Nickname wÃ¤hlen\n(Thema: NobelpreistrÃ¤ger, â€¦\noder Freitext, Story 3.2);
endif

|Server|
#ffe0b2:Participant INSERT\n@@unique(sessionId, nickname);
#ffe0b2:â†’ PUBLISH participantJoined;

|Dozent|
#c8e6c9:Live-Counter +1\nNickname in Lobby;

' â”€â”€â”€ Phase 5: Quiz-Schleife â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Dozent|
repeat
  #c8e6c9:â€NÃ¤chste Frage" klicken â–¶ï¸;

  |Server|
  #ffe0b2:currentQuestion++\nStatus = ACTIVE;
  #ffe0b2:QuestionStudentDTO erstellen\nâš ï¸ isCorrect ENTFERNT!;
  #ffe0b2:PUBLISH an alle Clients;

  |Student|
  #bbdefb:Frage + Countdown empfangen\n(Markdown/KaTeX gerendert\nâ–³â—‹â–¡â—‡ Buttons);

  if (Fragentyp?) then (SC)
    #bbdefb:1 Button antippen â†’ sofort senden\n(Debounce 300ms, Vibration);
  elseif (MC) then
    #bbdefb:Buttons togglen â†’ Absenden;
  elseif (Freitext) then
    #bbdefb:Text eingeben â†’ Absenden;
  elseif (Rating) then
    #bbdefb:Skala antippen (1 Tap)\nâ†’ ratingValue senden;
  elseif (Survey) then
    #bbdefb:Option wÃ¤hlen â†’ senden;
  endif

  |Server|
  #ffe0b2:Vote INSERT + VoteAnswer INSERT\n@@unique(session, participant, question);

  if (SC/MC & korrekt?) then (ja)
    #ffe0b2:score = DIFFICULTY Ã— timeBonus\nStreak++ â†’ streakMultiplier;
  else (nein/Survey/Rating/Freitext)
    #ffe0b2:score = 0\n(SURVEY/FREETEXT/RATING: Streak bleibt);
  endif

  #ffe0b2:â†’ voteCountUpdate (Broadcast);

  |Dozent|
  #c8e6c9:Live-Abstimmungsbalken\naktualisieren;
  #c8e6c9:â€Ergebnis zeigen" klicken ğŸ“ˆ;

  |Server|
  #ffe0b2:Status = RESULTS;
  #ffe0b2:QuestionRevealedDTO erstellen\nâœ… isCorrect ENTHALTEN!\n+ voteCount, votePercentage;
  #ffe0b2:â†’ onResultsRevealed (Broadcast);
  #ffe0b2:â†’ onPersonalResult (individuell pro Participant\n+ bonusToken bei letzter Frage);

  |Student|
  #bbdefb:Ergebnis: âœ… Richtig / âŒ Falsch;
  #bbdefb:PersÃ¶nliche Scorecard\n(Score, Streak, Rang, RangÃ¤nderung);
  #bbdefb:Motivationsmeldung\n(clientseitig generiert);

  if (Emoji-Reaktionen aktiv?) then (ja)
    #bbdefb:Emoji senden\n(ğŸ‘ ğŸ‰ ğŸ˜® ğŸ˜‚ ğŸ˜¢);
    |Server|
    #ffe0b2:PUBLISH Emoji\n(flÃ¼chtig, nicht persistiert);
    |Dozent|
    #c8e6c9:Emoji-Blasen auf Beamer;
  endif

  |Dozent|
  #c8e6c9:Ergebnis-Diagramm anzeigen\n(Balken / Wordcloud / Histogramm);
  if (showLeaderboard?) then (ja)
    #c8e6c9:Leaderboard-Zwischenstand (Top 5)\n(+ ğŸ”¥ bei Streak â‰¥ 3);
    if (teamMode?) then (ja)
      #c8e6c9:Team-Leaderboard anzeigen;
    endif
  endif

repeat while (Weitere Fragen?) is (ja)

' â”€â”€â”€ Phase 6: Quiz beenden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Dozent|
#c8e6c9:â€Quiz beenden" klicken ğŸ;

|Server|
#ffe0b2:Status = FINISHED;

if (bonusTokenCount > 0?) then (ja)
  #ffe0b2:Top-X ermitteln aus Leaderboard;
  #ffe0b2:BonusToken generieren\n(crypto.randomUUID,\nBNS-XXXX-XXXX Format);
  #ffe0b2:BonusToken INSERT je Platz\n(token, nickname, quizName,\ntotalScore, rank);
  #ffe0b2:â†’ onPersonalResult mit bonusToken\n(nur an Top-X, individuell);
endif

#ffe0b2:Redis-Keys lÃ¶schen â™»ï¸;
#ffe0b2:â†’ onStatusChanged: FINISHED;

|Student|
#bbdefb:Finales Ranking anzeigen;
if (Bonus-Token erhalten?) then (ja)
  #bbdefb:ğŸ“ â€Dein Bonus-Token: BNS-A3F7-K2M9"\nKopieren â†’ Zwischenablage;
  #bbdefb:Hinweis: â€Sende per E-Mail\nan Dozenten fÃ¼r Bonuspunkte.";
else (nein)
  #bbdefb:Normales finales Leaderboard;
endif

|Dozent|
#c8e6c9:Finales Leaderboard + Belohnungseffekte\n(ğŸ¥‡ Konfetti, ğŸ¥ˆ Jubel, ğŸ¥‰ Applaus);

if (bonusTokenCount > 0?) then (ja)
  #c8e6c9:session.getBonusTokens() aufrufen;
  #c8e6c9:Token-Tabelle anzeigen\n(Token, Pseudonym, Punkte, Rang, Datum);
  #c8e6c9:Optional: CSV exportieren;
endif

#c8e6c9:WebSocket-Verbindung geschlossen;

|Server|
#ffe0b2:Cleanup: 24h nicht beendete Sessions\n90 Tage: BonusToken auto-delete;

' â”€â”€â”€ Parallelpfad: Q&A-Modus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Dozent|
detach

|Dozent|
#c8e6c9:Q&A-Session starten\n(type = Q_AND_A\noptional: Titel, moderationMode);

|Server|
#ffe0b2:Session (LOBBY â†’ ACTIVE)\nkein Quiz, keine Fragen;

|Student|
#bbdefb:Session beitreten;
#bbdefb:Frage einreichen\n(max. 500 Zeichen, max. 3/Session);

|Server|
#ffe0b2:QaQuestion INSERT\n(participantId fÃ¼r 3-Fragen-Limit);

if (moderationMode?) then (ja)
  #ffe0b2:Status = PENDING;
  |Dozent|
  #c8e6c9:Frage freigeben / ablehnen;
  |Server|
  #ffe0b2:Status ACTIVE / DELETED;
else (nein)
  #ffe0b2:Status = ACTIVE (sofort sichtbar);
endif

#ffe0b2:â†’ qa.onQuestionsUpdated;

|Student|
#bbdefb:Andere Fragen upvoten (Toggle)\nâ†’ QaUpvote INSERT/DELETE;

|Dozent|
#c8e6c9:Fragen sortiert nach Upvotes\nsehen (Echtzeit);
#c8e6c9:Pin ğŸ“Œ / Archivieren âœ… / LÃ¶schen ğŸ—‘ï¸;

|Server|
#ffe0b2:QaQuestion.status UPDATE\nâ†’ Push Update;

|Dozent|
#c8e6c9:Q&A beenden;

|Server|
#ffe0b2:Status = FINISHED\nRedis Cleanup;

stop

legend right
  |= Farbe |= Akteur |
  | <back:#c8e6c9>    </back> | Dozent |
  | <back:#bbdefb>    </back> | Student |
  | <back:#ffe0b2>    </back> | Server |
  |= Symbol |= Bedeutung |
  | âš ï¸ | Data-Stripping: isCorrect entfernt |
  | âœ… | Data-Reveal: isCorrect mitgesendet |
  | ğŸ“ | Bonus-Token (Story 4.6) |
  | ğŸ‘ï¸ | Quiz-Preview-Modus (Story 1.13) |
  | â–³â—‹â–¡â—‡ | Formen-Codierung (Barrierefreiheit) |
  | ğŸ”¥ | Streak â‰¥ 3 |
  | â™»ï¸ | Cleanup (Redis + PostgreSQL) |
endlegend

@enduml
