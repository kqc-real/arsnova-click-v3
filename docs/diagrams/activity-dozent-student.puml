@startuml activity-dozent-student
' ============================================================================
' arsnova.click V3 â€“ Activity-Diagramm: Dozent / Student / Server
' VollstÃ¤ndiger Quiz-Lifecycle inkl. Bonus-Token, Preview, SC-Formate
' Stand: 2026-02-19 Â· 56 Storys Â· 9 Epics
' ============================================================================

!theme plain
skinparam shadowing false
skinparam activity {
  BackgroundColor #FEFEFE
  BorderColor #333333
}

title arsnova.click V3 â€” AktivitÃ¤tsdiagramm\nDozent Â· Student Â· Server

|#e8f5e9| Dozent |
|#e3f2fd| Student |
|#fff3e0| Server |

' â”€â”€â”€ Phase 1: Quiz erstellen (Local-First) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Dozent|
start
:Quiz erstellen\n(Name, Beschreibung);

if (Preset wÃ¤hlen?) then (ja)
  :ğŸ® Spielerisch **oder** ğŸ“ SeriÃ¶s\nauswÃ¤hlen (Story 1.11);
  :Toggles automatisch setzen\n(nach Wunsch anpassbar);
else (nein)
  :Einzelne Toggles manuell setzen\n(Leaderboard, Sound, Emoji, â€¦);
endif

:bonusTokenCount konfigurieren?\n(Story 4.6: Top X erhalten Token);

:Fragen hinzufÃ¼gen;

repeat
  if (Fragentyp?) then (SC)
    if (SC-Schnellformat?) then (ja)
      :Schnellformat wÃ¤hlen\n(Story 1.12: Ja/Nein,\nWahr/Falsch, A/B/C/D);
    else (nein)
      :Antworten manuell eingeben;
    endif
    :Korrekte Antwort(en) markieren;
  elseif (MC) then
    :Antworten eingeben\n(mehrere korrekt);
    :Korrekte markieren;
  elseif (Freitext) then
    :Nur Fragenstamm eingeben\n(keine Optionen);
  elseif (Rating) then
    :Skala konfigurieren\n(Min/Max, Labels);
  elseif (Survey) then
    :Optionen ohne isCorrect;
  endif

  :Schwierigkeitsgrad wÃ¤hlen\n(Easy/Medium/Hard);
  :Markdown & KaTeX im Editor\n(Story 1.7: Live-Preview);
  :In Yjs/IndexedDB speichern\n(Local-First, kein Server);

repeat while (Weitere Frage?) is (ja)

' â”€â”€â”€ Phase 2: Quiz-Preview (Story 1.13) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

:Quiz-Preview Ã¶ffnen ğŸ‘ï¸\n(Story 1.13);
:Fragen durchblÃ¤ttern\n(Hotkeys: â†’/â† N/P Home/End 1-9);
if (Validierungsprobleme?) then (ja)
  :âš ï¸ Warnung anklicken\nâ†’ zur Frage springen;
  :Inline-Schnellkorrektur\n(Text klicken / isCorrect togglen\n/ Hotkey E);
  :Ã„nderung â†’ sofort Yjs-Sync;
else (nein)
  :âœ… Alle Fragen valide\nâ€” bereit zum Live-Schalten;
endif

' â”€â”€â”€ Phase 3: Quiz live schalten â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

:\"Live schalten\" klicken;

|Server|
:Quiz-Daten empfangen\n(QuizUploadInputSchema validieren);
:Quiz + Questions + AnswerOptions\nin PostgreSQL speichern;
:Session erstellen\n(6-stelliger Code generieren\nStatus = LOBBY);

if (Session-Typ?) then (QUIZ)
  :quizId setzen;
else (Q_AND_A)
  :title setzen\nquizId = null;
endif

:â†’ { sessionId, code: "A3F7K2" };

|Dozent|
:Session-Code + QR-Code anzeigen\n(Beamer-Ansicht Ã¶ffnen);
:WebSocket-Subscriptions starten\n(onParticipantJoined,\nonStatusChanged);

' â”€â”€â”€ Phase 4: Studenten treten bei â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Student|
:Session-Code eingeben\n(6-stellig, Story 3.1);

|Server|
:Code validieren\n(Session existiert? Status=LOBBY?);

if (Rate-Limit OK?) then (ja)
  :âœ… Session-Info zurÃ¼ckgeben;
else (nein)
  :âŒ TOO_MANY_REQUESTS\n(5 Versuche / 5 Min);
  stop
endif

|Student|
if (anonymousMode?) then (ja)
  :Automatisches Pseudonym\nâ€Teilnehmer #7";
else (nein)
  :Nickname wÃ¤hlen\n(Thema: NobelpreistrÃ¤ger, â€¦\noder Freitext, Story 3.2);
endif

|Server|
:Participant INSERT\n@@unique(sessionId, nickname);
:â†’ PUBLISH participantJoined;

|Dozent|
:Live-Counter +1\nNickname in Lobby;

' â”€â”€â”€ Phase 5: Quiz-Schleife â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Dozent|
repeat
  :\"NÃ¤chste Frage\" klicken â–¶ï¸;

  |Server|
  :currentQuestion++\nStatus = ACTIVE;
  :QuestionStudentDTO erstellen\nâš ï¸ isCorrect ENTFERNT!;
  :PUBLISH an alle Clients;

  |Student|
  :Frage + Countdown empfangen\n(Markdown/KaTeX gerendert\nâ–³â—‹â–¡â—‡ Buttons);

  if (Fragentyp?) then (SC)
    :1 Button antippen â†’ sofort senden\n(Debounce 300ms, Vibration);
  elseif (MC) then
    :Buttons togglen â†’ Absenden;
  elseif (Freitext) then
    :Text eingeben â†’ Absenden;
  elseif (Rating) then
    :Skala antippen (1 Tap)\nâ†’ ratingValue senden;
  elseif (Survey) then
    :Option wÃ¤hlen â†’ senden;
  endif

  |Server|
  :Vote INSERT + VoteAnswer INSERT\n@@unique(session, participant, question);

  if (SC/MC & korrekt?) then (ja)
    :score = DIFFICULTY Ã— timeBonus\nStreak++ â†’ streakMultiplier;
  else (nein/Survey/Rating/Freitext)
    :score = 0\n(SURVEY/FREETEXT/RATING: Streak bleibt);
  endif

  :â†’ voteCountUpdate (Broadcast);

  |Dozent|
  :Live-Abstimmungsbalken\naktualisieren;
  :\"Ergebnis zeigen\" klicken ğŸ“ˆ;

  |Server|
  :Status = RESULTS;
  :QuestionRevealedDTO erstellen\nâœ… isCorrect ENTHALTEN!\n+ voteCount, votePercentage;
  :â†’ onResultsRevealed (Broadcast);
  :â†’ onPersonalResult (individuell pro Participant\n+ bonusToken bei letzter Frage);

  |Student|
  :Ergebnis: âœ… Richtig / âŒ Falsch;
  :PersÃ¶nliche Scorecard\n(Score, Streak, Rang, RangÃ¤nderung);
  :Motivationsmeldung\n(clientseitig generiert);

  if (Emoji-Reaktionen aktiv?) then (ja)
    :Emoji senden\n(ğŸ‘ ğŸ‰ ğŸ˜® ğŸ˜‚ ğŸ˜¢);
    |Server|
    :PUBLISH Emoji\n(flÃ¼chtig, nicht persistiert);
    |Dozent|
    :Emoji-Blasen auf Beamer;
  endif

  |Dozent|
  :Ergebnis-Diagramm anzeigen\n(Balken / Wordcloud / Histogramm);
  if (showLeaderboard?) then (ja)
    :Leaderboard-Zwischenstand (Top 5)\n(+ ğŸ”¥ bei Streak â‰¥ 3);
    if (teamMode?) then (ja)
      :Team-Leaderboard anzeigen;
    endif
  endif

repeat while (Weitere Fragen?) is (ja)

' â”€â”€â”€ Phase 6: Quiz beenden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Dozent|
:\"Quiz beenden\" klicken ğŸ;

|Server|
:Status = FINISHED;

if (bonusTokenCount > 0?) then (ja)
  :Top-X ermitteln aus Leaderboard;
  :BonusToken generieren\n(crypto.randomUUID,\nBNS-XXXX-XXXX Format);
  :BonusToken INSERT je Platz\n(token, nickname, quizName,\ntotalScore, rank);
  :â†’ onPersonalResult mit bonusToken\n(nur an Top-X, individuell);
endif

:Redis-Keys lÃ¶schen â™»ï¸;
:â†’ onStatusChanged: FINISHED;

|Student|
:Finales Ranking anzeigen;
if (Bonus-Token erhalten?) then (ja)
  :ğŸ“ â€Dein Bonus-Token: BNS-A3F7-K2M9"\nKopieren â†’ Zwischenablage;
  :Hinweis: â€Sende per E-Mail\nan Dozenten fÃ¼r Bonuspunkte.";
else (nein)
  :Normales finales Leaderboard;
endif

|Dozent|
:Finales Leaderboard + Belohnungseffekte\n(ğŸ¥‡ Konfetti, ğŸ¥ˆ Jubel, ğŸ¥‰ Applaus);

if (bonusTokenCount > 0?) then (ja)
  :session.getBonusTokens() aufrufen;
  :Token-Tabelle anzeigen\n(Token, Pseudonym, Punkte, Rang, Datum);
  :Optional: CSV exportieren;
endif

:WebSocket-Verbindung geschlossen;

|Server|
:Cleanup: 24h nicht beendete Sessions\n90 Tage: BonusToken auto-delete;

' â”€â”€â”€ Parallelpfad: Q&A-Modus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

|Dozent|
detach

|Dozent|
:Q&A-Session starten\n(type = Q_AND_A\noptional: Titel, moderationMode);

|Server|
:Session (LOBBY â†’ ACTIVE)\nkein Quiz, keine Fragen;

|Student|
:Session beitreten;
:Frage einreichen\n(max. 500 Zeichen, max. 3/Session);

|Server|
:QaQuestion INSERT\n(participantId fÃ¼r 3-Fragen-Limit);

if (moderationMode?) then (ja)
  :Status = PENDING;
  |Dozent|
  :Frage freigeben / ablehnen;
  |Server|
  :Status ACTIVE / DELETED;
else (nein)
  :Status = ACTIVE (sofort sichtbar);
endif

:â†’ qa.onQuestionsUpdated;

|Student|
:Andere Fragen upvoten (Toggle)\nâ†’ QaUpvote INSERT/DELETE;

|Dozent|
:Fragen sortiert nach Upvotes\nsehen (Echtzeit);
:Pin ğŸ“Œ / Archivieren âœ… / LÃ¶schen ğŸ—‘ï¸;

|Server|
:QaQuestion.status UPDATE\nâ†’ Push Update;

|Dozent|
:Q&A beenden;

|Server|
:Status = FINISHED\nRedis Cleanup;

stop

legend right
  |= Symbol |= Bedeutung |
  | âš ï¸ | Data-Stripping: isCorrect entfernt |
  | âœ… | Data-Reveal: isCorrect mitgesendet |
  | ğŸ“ | Bonus-Token (Story 4.6) |
  | ğŸ‘ï¸ | Quiz-Preview-Modus (Story 1.13) |
  | â–³â—‹â–¡â—‡ | Formen-Codierung (Barrierefreiheit) |
  | ğŸ”¥ | Streak â‰¥ 3 |
  | â™»ï¸ | Cleanup (Redis + PostgreSQL) |
endlegend

@enduml
