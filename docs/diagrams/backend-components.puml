@startuml backend-components
' ============================================================================
' arsnova.click V3 – Backend-Komponentendiagramm (Node.js, Stand: 2026-02-19)
' Express · tRPC · Prisma 7 · Redis · WebSocket · 56 Storys
' ============================================================================

!theme plain
skinparam shadowing false
skinparam component {
  BackgroundColor #FEFEFE
  BorderColor #333333
}

title arsnova.click V3 — Backend-Architektur (Node.js + tRPC)\nExpress · Prisma 7 · Redis · WebSocket

' ─── Entry Point ─────────────────────────────────────────────────────────────

package "Entry Point" #e0e0e0 {
  [Express Server\n(index.ts, Port 3000)] as express
  [CORS Middleware] as cors
  [tRPC Middleware\n(/trpc)] as trpcmw
}

' ─── tRPC Router ─────────────────────────────────────────────────────────────

package "appRouter (tRPC)" #e8f5e9 {
  [healthRouter] as health
  [quizRouter] as quiz
  [sessionRouter] as session
  [voteRouter] as voterouter
  [qaRouter] as qa

  note right of health
    **Endpoints:**
    health.check → Query
    health.stats → Query (Story 0.4)
    health.ping → Subscription (Heartbeat)
  end note

  note right of quiz
    **Endpoints:**
    quiz.upload → Mutation (Story 2.1a)
    quiz.getQuestions → Query
  end note

  note right of session
    **Endpoints:**
    session.create → Mutation
    session.getInfo → Query
    session.join → Mutation (Story 3.1)
    session.nextQuestion → Mutation
    session.revealResults → Mutation
    session.end → Mutation
    session.react → Mutation (Story 5.8)
    session.getLeaderboard → Query (Story 4.1)
    session.getTeamLeaderboard → Query (Story 7.1)
    **session.getBonusTokens** → Query (Story 4.6)
    --
    session.onParticipantJoined → Sub
    session.onQuestionRevealed → Sub
    session.onResultsRevealed → Sub
    session.onPersonalResult → Sub (Story 5.6)
    session.onStatusChanged → Sub
    session.onEmojiReaction → Sub (Story 5.8)
    session.onVoteCountUpdate → Sub
  end note

  note right of voterouter
    **Endpoints:**
    vote.submit → Mutation (Story 3.3b)
    Validierung: SubmitVoteInputSchema
    answerIds / freeText / ratingValue
  end note

  note right of qa
    **Endpoints:**
    qa.submit → Mutation (Story 8.2)
    qa.upvote → Mutation (Story 8.3)
    qa.moderate → Mutation (Story 8.4)
    qa.onQuestionsUpdated → Sub
  end note
}

' ─── Services ────────────────────────────────────────────────────────────────

package "Services" #fff3e0 {
  [ScoringService\nscore = difficulty × timeBonus\n× streakMultiplier] as scoring
  [StreakService\n2:×1.1, 3:×1.2, 4:×1.3, 5+:×1.5] as streak
  [SessionCodeService\n(6-stellig, eindeutig)] as codegen
  [CleanupService\n(24h + 90d BonusToken)] as cleanup
  [RateLimitService\n(Sliding Window, Redis)] as ratelimit
  [BonusTokenService\n(crypto.randomUUID, nanoid)] as tokenservice
}

note right of tokenservice
  **Story 4.6:**
  Generiert BNS-XXXX-XXXX Tokens
  für Top-X bei session.end.
  Speichert Snapshots (nickname, quizName,
  totalScore, rank) in PostgreSQL.
  90-Tage-TTL danach auto-delete.
end note

note right of scoring
  **Punkteformel (Story 4.1):**
  score = DIFFICULTY_MULTIPLIER(d)
        x MAX_BASE_POINTS
        x (1 - responseTime / timer)
  finalScore = score × streakMultiplier
  FREETEXT, SURVEY, RATING = 0 Punkte
end note

' ─── DTO Layer ───────────────────────────────────────────────────────────────

package "DTO Layer (Data-Stripping)" #fce4ec {
  [QuestionStudentDTO\n⚠️ KEIN isCorrect!] as studdto
  [QuestionRevealedDTO\n✅ MIT isCorrect] as revdto
  [AnswerOptionStudentDTO] as ansstuddto
  [AnswerOptionRevealedDTO\n(voteCount, votePercentage)] as ansrevdto
  [SessionInfoDTO\n(type, title, code)] as sessiondto
  [ParticipantDTO] as partdto
  [LeaderboardEntryDTO] as lbdto
  [PersonalScorecardDTO\n(+ bonusToken: String?)] as scoredto
  [TeamLeaderboardEntryDTO] as teamlbdto
  [RatingResultDTO\n(distribution, avg, stddev)] as ratingdto
  [BonusTokenEntryDTO\n(token, nickname, score, rank)] as tokenentrydto
  [BonusTokenListDTO\n(sessionId, code, quizName, tokens)] as tokenlistdto
  [QaQuestionDTO\n(hasUpvoted)] as qadto
  [ServerStatsDTO] as statsdto
}

note bottom of studdto
  ⚠️ **Story 2.4 — KRITISCH:**
  Im Status ACTIVE wird isCorrect
  serverseitig entfernt. Erst nach
  expliziter Auflösung (RESULTS)
  wird QuestionRevealedDTO gesendet.
end note

' ─── Validation ──────────────────────────────────────────────────────────────

package "Validation (@arsnova/shared-types)" #e3f2fd {
  [CreateQuizInputSchema] as createquiz
  [AddQuestionInputSchema\n(+ ratingMin/Max/Labels)] as addquestion
  [QuizUploadInputSchema\n(+ bonusTokenCount)] as quizupload
  [CreateSessionInputSchema\n(type, title, moderationMode)] as createsession
  [JoinSessionInputSchema] as joinsession
  [SubmitVoteInputSchema\n(answerIds, freeText, ratingValue)] as submitvote
  [SendEmojiReactionInputSchema] as emojischema
  [SubmitQaQuestionInputSchema] as qainput
  [UpvoteQaQuestionInputSchema] as qaupvoteinput
  [QuizExportSchema\n(+ bonusTokenCount)] as exportschema
  note bottom of createquiz
    Alle Schemas werden in
    Backend **und** Frontend
    verwendet (Ende-zu-Ende).
  end note
}

' ─── Externe Systeme ─────────────────────────────────────────────────────────

database "PostgreSQL 16\n(Prisma 7 ORM)" as pg
database "Redis 7\n(Pub/Sub + Rate-Limit)" as redis
cloud "WebSocket Server\n(tRPC wsLink)" as wss
cloud "y-websocket Relay\n(Yjs CRDT-Sync)" as yws

' ─── Verbindungen ────────────────────────────────────────────────────────────

express --> cors
cors --> trpcmw
trpcmw --> health
trpcmw --> quiz
trpcmw --> session
trpcmw --> voterouter
trpcmw --> qa

session --> scoring
session --> streak
session --> codegen
session --> cleanup
session --> tokenservice
voterouter --> scoring
voterouter --> streak
voterouter --> ratelimit
qa --> ratelimit

health ..> statsdto
quiz ..> quizupload
session ..> createsession
session ..> sessiondto
session ..> partdto
session ..> studdto
session ..> revdto
session ..> lbdto
session ..> teamlbdto
session ..> scoredto
session ..> ratingdto
session ..> tokenlistdto
voterouter ..> submitvote
qa ..> qainput
qa ..> qadto

scoring --> pg
streak --> pg
tokenservice --> pg
cleanup --> pg
cleanup --> redis
ratelimit --> redis
session --> redis : Pub/Sub
session --> wss : Broadcast
express --> yws

@enduml
