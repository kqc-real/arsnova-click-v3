@startuml db-schema
' ============================================================================
' arsnova.click V3 â€“ ER-Diagramm (Prisma-Schema, Stand: 2026-02-19)
' 12 Modelle Â· 8 Enums Â· Alle Relationen
' ============================================================================

!theme plain
skinparam linetype ortho
skinparam shadowing false
skinparam class {
  BackgroundColor #FEFEFE
  BorderColor #333333
  ArrowColor #555555
}

title arsnova.click V3 â€” Datenbank-Schema (PostgreSQL)\n12 Modelle Â· 8 Enums

' â”€â”€â”€ Quiz-Verwaltung â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

package "Quiz-Verwaltung" #e8f5e9 {
  entity "User" as user {
    * **id** : UUID <<PK>>
    --
    email : String <<UNIQUE>>
    password : String
    createdAt : DateTime
  }

  entity "Quiz" as quiz {
    * **id** : UUID <<PK>>
    --
    name : String
    description : String?
    isPublic : Boolean = false
    showLeaderboard : Boolean = true
    allowCustomNicknames : Boolean = true
    defaultTimer : Int?
    enableSoundEffects : Boolean = true
    enableRewardEffects : Boolean = true
    enableMotivationMessages : Boolean = true
    enableEmojiReactions : Boolean = true
    anonymousMode : Boolean = false
    teamMode : Boolean = false
    teamCount : Int?
    teamAssignment : TeamAssignment = AUTO
    backgroundMusic : String?
    nicknameTheme : NicknameTheme = NOBEL_LAUREATES
    **bonusTokenCount : Int?** â† Story 4.6
    creatorId : UUID? <<FK>>
    createdAt : DateTime
    updatedAt : DateTime
  }

  entity "Question" as question {
    * **id** : UUID <<PK>>
    --
    text : String
    type : QuestionType
    timer : Int?
    difficulty : Difficulty = MEDIUM
    ratingMin : Int?
    ratingMax : Int?
    ratingLabelMin : String?
    ratingLabelMax : String?
    quizId : UUID <<FK>>
    order : Int
  }

  entity "AnswerOption" as answer {
    * **id** : UUID <<PK>>
    --
    text : String
    **isCorrect : Boolean**
    questionId : UUID <<FK>>
  }

  note right of answer
    âš ï¸ **Data-Stripping (Story 2.4):**
    isCorrect wird im Status ACTIVE
    **niemals** an Studenten gesendet!
    Erst nach RESULTS-AuflÃ¶sung sichtbar.
  end note
}

' â”€â”€â”€ Live-Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

package "Live-Session" #fff3e0 {
  entity "Session" as session {
    * **id** : UUID <<PK>>
    --
    code : String <<UNIQUE>>
    type : SessionType = QUIZ
    status : SessionStatus = LOBBY
    title : String?
    moderationMode : Boolean = false
    currentQuestion : Int?
    quizId : UUID? <<FK>>
    startedAt : DateTime
    endedAt : DateTime?
  }

  entity "Participant" as participant {
    * **id** : UUID <<PK>>
    --
    nickname : String
    sessionId : UUID <<FK>>
    teamId : UUID? <<FK>>
    joinedAt : DateTime
    --
    <<UNIQUE>> (sessionId, nickname)
  }

  entity "Team" as team {
    * **id** : UUID <<PK>>
    --
    name : String
    color : String?
    sessionId : UUID <<FK>>
    --
    <<UNIQUE>> (sessionId, name)
  }

  entity "Vote" as vote {
    * **id** : UUID <<PK>>
    --
    sessionId : UUID <<FK>>
    participantId : UUID <<FK>>
    questionId : UUID <<FK>>
    freeText : String?
    ratingValue : Int?
    responseTimeMs : Int?
    score : Int = 0
    streakCount : Int = 0
    streakBonus : Float = 1.0
    votedAt : DateTime
    --
    <<UNIQUE>> (session, participant, question)
  }

  entity "VoteAnswer" as voteanswer {
    * **id** : UUID <<PK>>
    --
    voteId : UUID <<FK>>
    answerOptionId : UUID <<FK>>
    --
    <<UNIQUE>> (voteId, answerOptionId)
  }

  note bottom of voteanswer
    n:m Join-Tabelle fÃ¼r
    MC-Mehrfachauswahl
  end note
}

' â”€â”€â”€ Bonus-Token (Story 4.6) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

package "Bonus-Token" #e3f2fd {
  entity "BonusToken" as bonustoken {
    * **id** : UUID <<PK>>
    --
    **token : String <<UNIQUE>>**
    sessionId : UUID <<FK>>
    participantId : UUID <<FK>>
    nickname : String (Snapshot)
    quizName : String (Snapshot)
    totalScore : Int
    rank : Int
    generatedAt : DateTime
  }

  note bottom of bonustoken
    ğŸ“ **Story 4.6:**
    Kryptografisch sicher (BNS-A3F7-K2M9).
    Nur Top-X erhalten Token.
    90-Tage-Aufbewahrung, dann auto-delete.
    AnonymitÃ¤t bewahrt bis freiwillig
    per E-Mail eingereicht.
  end note
}

' â”€â”€â”€ Q&A-Modus (Epic 8) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

package "Q&A-Modus" #fce4ec {
  entity "QaQuestion" as qaquestion {
    * **id** : UUID <<PK>>
    --
    text : String
    upvoteCount : Int = 0
    status : QaQuestionStatus = ACTIVE
    sessionId : UUID <<FK>>
    participantId : UUID <<FK>>
    createdAt : DateTime
  }

  entity "QaUpvote" as qaupvote {
    * **id** : UUID <<PK>>
    --
    qaQuestionId : UUID <<FK>>
    participantId : UUID <<FK>>
    --
    <<UNIQUE>> (qaQuestionId, participantId)
  }
}

' â”€â”€â”€ Enums â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

package "Enums" #f3e5f5 {
  enum QuestionType {
    MULTIPLE_CHOICE
    SINGLE_CHOICE
    FREETEXT
    SURVEY
    RATING
  }

  enum Difficulty {
    EASY (Ã—1)
    MEDIUM (Ã—2)
    HARD (Ã—3)
  }

  enum SessionStatus {
    LOBBY
    ACTIVE
    PAUSED
    RESULTS
    FINISHED
  }

  enum SessionType {
    QUIZ
    Q_AND_A
  }

  enum NicknameTheme {
    NOBEL_LAUREATES
    KINDERGARTEN
    PRIMARY_SCHOOL
    MIDDLE_SCHOOL
    HIGH_SCHOOL
  }

  enum TeamAssignment {
    AUTO
    MANUAL
  }

  enum QaQuestionStatus {
    PENDING
    ACTIVE
    PINNED
    ARCHIVED
    DELETED
  }
}

' â”€â”€â”€ Relationen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

user ||--o{ quiz : "erstellt"
quiz ||--o{ question : "enthÃ¤lt"
question ||--o{ answer : "hat"
quiz ||--o{ session : "wird gespielt in"
session ||--o{ participant : "nimmt teil"
session ||--o{ team : "hat Teams"
team ||--o{ participant : "Mitglieder"
session ||--o{ vote : "Stimmen"
participant ||--o{ vote : "stimmt ab"
question ||--o{ vote : "befragt"
vote ||--o{ voteanswer : "wÃ¤hlt aus"
answer ||--o{ voteanswer : "wird gewÃ¤hlt"
session ||--o{ bonustoken : "vergibt"
participant ||--o{ bonustoken : "erhÃ¤lt"
session ||--o{ qaquestion : "Q&A-Fragen"
participant ||--o{ qaquestion : "stellt"
qaquestion ||--o{ qaupvote : "wird gevotet"
participant ||--o{ qaupvote : "votet"

@enduml
